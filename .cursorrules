# Siv3D Documentation Tools - Monorepo

## Project Overview
This monorepo provides tooling for the Siv3D documentation ecosystem. It processes Siv3D documentation (Markdown) into searchable chunks and serves them through various APIs for integration with AI tools like Claude Code and ChatGPT GPTs.



## Monorepo Structure

### üåê API Service (`api/`)
**Primary Component**: Cloudflare Workers-based API server
- **Framework**: Hono with TypeScript
- **Deployment**: Cloudflare Workers + R2 + Algolia
- **Interfaces**:
  - **MCP Server** (`/mcp`) - Model Context Protocol for Claude Code
  - **REST API** (`/api/*`) - OpenAPI-compliant endpoints for GPTs
  - **Static Assets** - OpenAPI documentation serving



### üîß Processing Actions (All Other Directories)
**GitHub Actions-based data processing pipeline**

#### `chunk-generator/`
Converts Siv3D documentation into search-optimized chunks
- **Input**: siv3d.docs directory + language + version
- **Output**: `chunks.json` + individual code block files
- **Environment**: GitHub Actions only (no CLI support)
- **Key Features**:
  - Markdown AST parsing with mdast
  - Section-based content splitting (1000 char limit)
  - MkDocs admonition support
  - Heading hierarchy preservation
  - Code block extraction

#### `algolia-uploader/`
Uploads processed chunks to Algolia search indexes
- **Input**: `chunks.json` + Algolia credentials
- **Output**: Updated Algolia search index
- **Environment**: GitHub Actions only
- **Features**:
  - Batch upload to Algolia
  - Data validation with Zod schemas
  - Language-specific index management

## Development Workflow

### API Development (`api/`)
```bash
# Local development with remote bindings
cd api
yarn dev

# Type generation for Cloudflare bindings
yarn generate-types

# Deploy to production
yarn deploy
```

### Actions Development (`chunk-generator/`, `algolia-uploader/`)
```bash
# Build for GitHub Actions
cd chunk-generator
yarn build  # Creates dist/index.js for node20 runtime

cd algolia-uploader
yarn build  # Creates dist/index.js for node20 runtime
```

### Full Pipeline Execution
Triggered by GitHub Actions workflow (`.github/workflows/deploy-docs.yml`):
1. **Input**: siv3d.docs commit hash
2. **chunk-generator**: Generate chunks for ja-jp and en-us
3. **algolia-uploader**: Upload to respective Algolia indexes
4. **R2 sync**: Upload markdown + code blocks to Cloudflare R2

## Technical Specifications

### Data Models
- **Chunk Schema**: Defined in `chunk-generator/schema.ts`
- **CodeBlock Schema**: Shared across processing pipeline
- **Validation**: All schemas use Zod for runtime type checking

### GitHub Actions Integration

#### Environment Variables (Actions Input)
**chunk-generator**:
- `INPUT_SIV3D-DOCS-DIR` - siv3d.docs directory path
- `INPUT_SIV3D-DOCS-LANGUAGE` - "en-us" or "ja-jp"  
- `INPUT_SIV3D-DOCS-VERSION` - Git commit hash
- `INPUT_CHUNKS-OUTPUT-FILE` - Output JSON file path
- `INPUT_CODE-BLOCKS-OUTPUT-DIR` - Code blocks directory
- `INPUT_DISABLE-VALIDATION` - Skip validation (optional)

**algolia-uploader**:
- `INPUT_ALGOLIA-APP-ID` - Algolia application ID
- `INPUT_ALGOLIA-API-KEY` - Algolia write API key
- `INPUT_ALGOLIA-INDEX-NAME` - Target index name
- `INPUT_CHUNKS-FILE-PATH` - Input chunks.json path
- `INPUT_SIV3D-DOCS-VERSION` - Version for metadata

### Cloudflare Workers Configuration

#### Required Bindings
- **R2 Storage**: `SIV3D_DOCS_STORAGE` for file operations
- **Assets**: Static file serving capability
- **Environment Variables**: Algolia credentials and configuration

#### Supported Languages
- `en-us` - English documentation
- `ja-jp` - Japanese documentation

## Implementation Guidelines

### TypeScript Patterns
- **Zod Validation**: All data structures validated at runtime
- **Type Safety**: Strict TypeScript configuration across all projects
- **Error Handling**: Proper HTTP status codes and descriptive error messages
- **Environment Variables**: GitHub Actions environment variable pattern

### API Design Principles
- **MCP Compliance**: Follow Model Context Protocol specifications
- **OpenAPI**: REST endpoints documented and validated
- **Content Delivery**: Structured Markdown responses for AI consumption
- **Caching**: Leverage Cloudflare Workers edge caching

### Code Organization
- **Shared Schemas**: Common data models in `chunk-generator/schema.ts`
- **Modular Architecture**: Clear separation between parsing, processing, and serving
- **Single Responsibility**: Each action/service handles one specific task

### Constants and Limits
- `CONTENT_MAX_LENGTH = 1000` - Maximum chunk content size
- **Node.js 20** - Runtime target for all components
- **ESNext + NodeNext** - TypeScript compilation target
- **Cloudflare Workers** - Edge runtime limitations apply

## Dependencies Overview
- **Package Manager**: Yarn (all projects)
- **Runtime**: Node.js 20+ with TypeScript 5.8+
- **Build Tool**: esbuild for production bundles
- **Validation**: Zod for runtime type checking
- **Key Frameworks**: Hono (API), mdast (Markdown), Algolia SDK

## Special Features

### MkDocs Compatibility
- **Admonition Parsing** - Custom parser for MkDocs admonitions
- **Heading ID Generation** - Compatible with MkDocs anchor links
- **URL Generation** - Proper siv3d.github.io linking

### AI Integration
- **MCP Protocol** - Native Claude Code integration
- **Structured Output** - Markdown responses optimized for AI consumption
- **GPT Actions** - OpenAPI-compatible REST endpoints

### Production Deployment
- **Multi-stage Pipeline** - Separate data generation and API deployment
- **Version Tracking** - Git commit-based versioning
- **Multi-language Support** - Parallel processing for en-us and ja-jp